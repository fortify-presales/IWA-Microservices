name: Changed Services Detector

on:
  push:
    branches: [ main, develop, feature/**, hotfix/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:


permissions:
  contents: read
  packages: write
  id-token: write

env:
  SERVICES_DIRS: "apps gateway services"

jobs:
  detect:
    name: Detect changed services
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Determine changed files
      id: changes
      run: |
        echo "GITHUB_EVENT_NAME=${GITHUB_EVENT_NAME}"
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "PR detected"
          git fetch origin +refs/heads/${{ github.base_ref }}:refs/remotes/origin/${{ github.base_ref }}
          BASE=${{ github.event.pull_request.base.sha }}
          HEAD=${{ github.event.pull_request.head.sha }}
        else
          BASE=${{ github.event.before }}
          HEAD=${{ github.sha }}
        fi
        echo "Base=$BASE"; echo "Head=$HEAD"
        git diff --name-only $BASE $HEAD > changed_files.txt || true
        echo "Changed files:"; cat changed_files.txt
        # export the changed files as a multiline step output
        echo "files<<EOF" >> $GITHUB_OUTPUT
        cat changed_files.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Build matrix of changed services
      id: set-matrix
      run: |
        files=$(cat changed_files.txt || true)
        echo "Parsing changed files..."
        services=()

        # map changes under apps/ and services/ and apps/gateway
        while IFS= read -r f; do
          if [[ "$f" == apps/gateway/* ]] || [[ "$f" == apps/gateway"" ]]; then
            svc="gateway"
          elif [[ "$f" == apps/* ]]; then
            # apps/<name>/...
            svc=$(echo "$f" | cut -d'/' -f2)
          elif [[ "$f" == services/* ]]; then
            svc=$(echo "$f" | cut -d'/' -f2)
          else
            svc=""
          fi
          if [[ -n "$svc" ]]; then
            # dedupe
            if [[ ! " ${services[@]} " =~ " ${svc} " ]]; then
              services+=("$svc")
            fi
          fi
        done <<< "$files"

        if [ ${#services[@]} -eq 0 ]; then
          echo "No services changed. Exiting." 
          # No services changed â€” emit an empty matrix output (empty string) so dispatch job is skipped
          echo "matrix<<EOF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          exit 0
        fi

        # build JSON matrix
        echo -n '{"include":[' > matrix.json
        first=true
        for s in "${services[@]}"; do
          if [ "$first" = true ]; then
            first=false
          else
            echo -n ',' >> matrix.json
          fi
          # decide path
          if [ "$s" = "gateway" ]; then
            path="apps/gateway"
          else
            path="services/$s"
          fi
          printf '{"service":"%s","path":"%s"}' "$s" "$path" >> matrix.json
        done
        echo ']}' >> matrix.json
        cat matrix.json
        # write matrix JSON as a multiline step output (clean JSON only)
        echo "matrix<<EOF" >> $GITHUB_OUTPUT
        cat matrix.json >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

  preview:
    name: Preview matrix (debug)
    needs: detect
    runs-on: ubuntu-latest
    if: needs.detect.outputs.matrix != ''
    steps:
    - name: Print raw matrix JSON
      run: |
        echo "----- Raw matrix JSON -----"
        echo "${{ needs.detect.outputs.matrix }}"
        echo "---------------------------"

    - name: List matrix entries
      uses: actions/github-script@v7
      with:
        script: |
          const m = JSON.parse(process.env.MATRIX || '{}')
          console.log('Parsed matrix:')
          console.log(JSON.stringify(m, null, 2))
          if (Array.isArray(m.include)) {
            m.include.forEach(it => console.log(`service=${it.service}, path=${it.path}`))
          } else {
            console.log('No include array found in matrix')
          }
      env:
        MATRIX: ${{ needs.detect.outputs.matrix }}

  dispatch:
    name: Dispatch CI per changed service
    needs: detect
    if: needs.detect.outputs.matrix != ''
    # Run the reusable workflow as a job and expand a matrix from the detected include array
    uses: fortify-presales/IWA-Microservices/.github/workflows/service-ci-cd.yml@main
    strategy:
      matrix: ${{ fromJson(needs.detect.outputs.matrix).include }}
    with:
      service: ${{ matrix.service }}
      path: ${{ matrix.path }}
      deploy: ${{ github.ref == 'refs/heads/main' }}
      fortify: false
    secrets: inherit # pass down all secrets to the reusable workflow
