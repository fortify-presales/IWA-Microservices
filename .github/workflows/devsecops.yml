# Create GitHub Action Repository Variables for your version of the application:
#   FOD_URL                     - FoD Portal URL for your tenant (e.g. https://ams.fortify.com)
#   FOD_API_URL                 - FoD API URL for your tenant (e.g. https://api.ams,fortify.com)
#   FOD_APP_NAME_POSTFIX        - A postfix string to apply to the application to make it unique, set to empty to use DEFAULT_APP_NAME
#   FOD_DEFAULT_OWNER           - The user id of the Application Owner (only needed if an application does not already exist)
#   FOD_DEFAULT_ASSESSMENT_TYPE - The default Assessment Type to use, e.g. "Static Assessment"
# Create GitHub Action Secrets for your version of the application:
#   FOD_CLIENT_ID should be an API Key obtained from your FoD tenant.
#   FOD_CLIENT_SECRET should be the secret for the API Key obtained for your FoD tenant.
# Helpful hints:
#   API Key credentials can be obtained from your FoD tenant, under Administration -> Settings -> API
#   It is recommended to create credentials with 'Security Lead' Role selected.
#   "Automated Audit preference" should be configured for the release's Static Scan Settings.
name: DevSecOps Pipeline

on:
  push:
    branches: [ main, develop, feature/**, hotfix/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write

env:
  JAVA_VERSION: '17'
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/iwa-microservices
  DEFAULT_APP_NAME: "IWA-Microservices"
  DEFAULT_PARENT_RELEASE_NAME: "main"

jobs:

  env-prepare:
    name: Prepare Environment
    runs-on: ubuntu-latest
    outputs:
      FOD_APPLICATION: ${{ steps.commands.outputs.FOD_APPLICATION }}
      FOD_RELEASE: ${{ steps.commands.outputs.FOD_RELEASE }}
      FOD_PARENT_RELEASE: ${{ steps.commands.outputs.FOD_PARENT_RELEASE }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Set up environment variables
      id: commands
      run: |
        echo "FOD_APPLICATION=${{ env.DEFAULT_APP_NAME }}${{ vars.FOD_APP_NAME_POSTFIX }}" >> $GITHUB_OUTPUT
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "Running in a pull request pipeline ..."
          echo "FOD_RELEASE=merge-to-${{ github.base_ref }}#PR${{ github.event.number }}" >> $GITHUB_OUTPUT
          echo "FOD_PARENT_RELEASE=${{ github.head_ref }}" >> $GITHUB_OUTPUT
        else
          echo "Running in a branch pipeline ..."
          echo "FOD_RELEASE=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "FOD_PARENT_RELEASE=${{ env.DEFAULT_PARENT_RELEASE_NAME }}" >> $GITHUB_OUTPUT
        fi 

  build:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: env-prepare

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Build with Gradle
      run: ./gradlew build -x test
    
    - name: Run tests
      run: ./gradlew test || true
    
    - name: Archive build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          apps/*/build/libs/*.jar
          services/*/build/libs/*.jar
        retention-days: 5
  
  #trivy-security-scan:
  #  name: Security Scanning
  #  runs-on: ubuntu-latest
  #  needs: build
  #  
  #  steps:
  #  - name: Checkout code
  #    uses: actions/checkout@v4
  #  
  #  - name: Run Trivy vulnerability scanner
  #    uses: aquasecurity/trivy-action@master
  #    with:
  #      scan-type: 'fs'
  #      scan-ref: '.'
  #      format: 'sarif'
  #      output: 'trivy-results.sarif'
  #  
  #  - name: Upload Trivy results to GitHub Security tab
  #    uses: github/codeql-action/upload-sarif@v3
  #    if: always()
  #    with:
  #      sarif_file: 'trivy-results.sarif'
  
  build-docker-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'
    
    strategy:
      matrix:
        service:
          - gateway
          - catalog
          - customers
          - orders
          - payments
          - prescriptions
          - inventory
          - notifications
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=semver,pattern={{version}}
    
    - name: Determine Dockerfile path
      id: dockerfile
      run: |
        if [ "${{ matrix.service }}" == "gateway" ]; then
          echo "path=apps/gateway/Dockerfile" >> $GITHUB_OUTPUT
        else
          echo "path=services/${{ matrix.service }}/Dockerfile" >> $GITHUB_OUTPUT
        fi
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ steps.dockerfile.outputs.path }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

  deploy-to-azure:
    name: Deploy to Azure Container Apps
    runs-on: ubuntu-latest
    needs: build-docker-images
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    
    - name: Deploy to Azure Container Apps
      run: |
        az account show
        echo "Deployment to Azure Container Apps would happen here"
    #    pwsh ./deploy/azure/deploy.ps1 -ImageTag ${{ env.IMAGE_TAG }}

  fortify-ast-scan:
    name: Fortify AST Scan (per service/app)
    runs-on: ubuntu-latest
    needs: [ build, env-prepare ]
    if: github.event_name != 'pull_request' || github.actor == 'dependabot[bot]'
    env: 
      FOD_APPLICATION: ${{ needs.env-prepare.outputs.FOD_APPLICATION }}
      FOD_RELEASE: ${{ needs.env-prepare.outputs.FOD_RELEASE }}
      FOD_PARENT_RELEASE: ${{ needs.env-prepare.outputs.FOD_PARENT_RELEASE }}

    strategy:
      matrix:
        service:
          - gateway
          - catalog
          - customers
          - orders
          - payments
          - prescriptions
          - inventory
          - notifications

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Set up Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: '8.5'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Determine project path
      id: project
      run: |
        if [ "${{ matrix.service }}" = "gateway" ]; then
          echo "path=apps/gateway" >> $GITHUB_OUTPUT
          echo "target=:apps:gateway:build" >> $GITHUB_OUTPUT
        else
          echo "path=services/${{ matrix.service }}" >> $GITHUB_OUTPUT
          echo "target=:services:${{ matrix.service }}:build" >> $GITHUB_OUTPUT
        fi

    - name: Setup Fortify tools
      uses: fortify/github-action/setup@v2
      with:
        tool-definitions: https://github.com/fortify/tool-definitions/releases/download/v1/tool-definitions.yaml.zip
        export-path: true
        fcli: latest
        sc-client: latest

    - name: Create Fortify package
      run: |
        cd ${{ steps.project.outputs.path }}
        pwd
        # Create the Fortify package.zip using the appropriate build commands
        scancentral package -o package.zip \
          -bt gradle \
          -bf build.gradle \
          -bc "clean build -x test" 
        ls -la package.zip

    - name: Upload package and run scan
      run: |
        cd ${{ steps.project.outputs.path }}
        pwd
        ls -la package.zip
        fcli fod session login --url $FOD_API_URI --client-id $FOD_CLIENT_ID --client-secret $FOD_CLIENT_SECRET --fod-session github-actions
        fcli fod sast-scan start --release "$FOD_APP_MS_RELEASE" -f package.zip --store curScan --fod-session github-actions
        fcli fod sast-scan wait-for ::curScan:: --fod-session github-actions
        fcli fod session logout --fod-session github-actions
      env:
        FOD_API_URI: ${{ vars.FOD_API_URL }}
        FOD_CLIENT_ID: ${{ secrets.FOD_CLIENT_ID }}
        FOD_CLIENT_SECRET: ${{ secrets.FOD_CLIENT_SECRET }}
        FOD_APP_MS_RELEASE: ${{ format('{0}:{1}:{2}', env.FOD_APPLICATION, matrix.service, github.ref_name) }}

        
    #- name: Run Fortify GitHub Action
    #  #uses: fortify/github-action@v2
    #  uses: fortify/github-action@feat/fcli-ci
    #  #continue-on-error: true   # uncomment if you want scans to be non-blocking
    #  with:
    #    # Enable SAST scan and Debricked SCA scan
    #    sast-scan: true
    #    debricked-sca-scan: false
    #  env:
    #    #FCLI_URL: https://github.com/fortify/fcli/releases/download/dev_refactor.ci-rest-helpers/fcli-linux.tgz
    #    SOURCE_DIR: ${{ steps.project.outputs.path }}
    #    FOD_URL: ${{ vars.FOD_API_URL }}
    #    #FOD_TENANT: ${{secrets.FOD_TENANT}}
    #    #FOD_USER: ${{secrets.FOD_USER}}
    #    #FOD_PASSWORD: ${{secrets.FOD_PAT}}
    #    FOD_CLIENT_ID: ${{secrets.FOD_CLIENT_ID}}
    #    FOD_CLIENT_SECRET: ${{secrets.FOD_CLIENT_SECRET}}
    #    # FOD_LOGIN_EXTRA_OPTS: --socket-timeout=60s
    #    FOD_RELEASE: ${{ format('{0}:{1}:{2}',env.FOD_APPLICATION, matrix.service, github.ref_name) }}
    #    DO_SETUP: true
    #    SETUP_EXTRA_OPTS: ${{ format('--copy-from "{0}:{1}:{2}" --sdlc-status Development --app-owner {3} --assessment-type "{4}"', env.FOD_APPLICATION, matrix.service, env.FOD_PARENT_RELEASE, vars.FOD_DEFAULT_OWNER, vars.FOD_DEFAULT_ASSESSMENT_TYPE) }}
    #    PACKAGE_EXTRA_OPTS: ${{ format('-bt gradle -bf build.gradle -bc "clean build -x test"') }}
    #    #USE_PACKAGE: ${{ format('{0}/{1}', steps.project.outputs.path, 'package.zip') }}
    #    # FOD_SAST_SCAN_EXTRA_OPTS:
    #    DO_WAIT: true
    #    DO_POLICY_CHECK: true
    #    DO_JOB_SUMMARY: true
    #    DO_PR_COMMENT: true
    #    DO_EXPORT: true
